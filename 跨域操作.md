éå¸¸å¥½çš„é—®é¢˜ï¼ä½ å·²ç»åœ¨ä½¿ç”¨ Flask-CORSï¼ˆé€šè¿‡ `cors.init_app(app)`ï¼‰ï¼Œå¹¶ä¸”æåˆ°äº† `supports_credentials=True`ï¼Œè¿™è¯´æ˜ä½ å¯èƒ½åœ¨åš**è·¨åŸŸ + å¸¦ Cookie æˆ– Authorization çš„è¯·æ±‚**ï¼ˆæ¯”å¦‚å‰ç«¯åœ¨ `localhost:3000`ï¼Œåç«¯åœ¨ `localhost:5000`ï¼‰ã€‚

---

## âœ… `Flask-CORS` çš„å¸¸ç”¨å‚æ•°

`CORS` åˆå§‹åŒ–æ—¶å¯ä»¥é€šè¿‡ `init_app()` ä¼ å…¥å¤šç§é…ç½®é¡¹ã€‚ä»¥ä¸‹æ˜¯**æœ€å¸¸ç”¨å’Œé‡è¦çš„å‚æ•°**ï¼š

```python
from flask_cors import CORS

cors = CORS()
# æˆ–ç›´æ¥åˆå§‹åŒ–ï¼šcors = CORS(app, **options)
```

### åœ¨ `create_app()` ä¸­é…ç½®ç¤ºä¾‹ï¼š
```python
cors.init_app(app, 
    supports_credentials=True,
    origins=["http://localhost:3000", "https://your-frontend.com"],
    methods=["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    allow_headers=["Content-Type", "Authorization", "X-Requested-With"]
)
```

---

## ğŸ”‘ æ ¸å¿ƒå‚æ•°è¯¦è§£

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| **`origins`** | `str`, `list`, `regex` | å…è®¸çš„å‰ç«¯åŸŸåã€‚é»˜è®¤æ˜¯ `*`ï¼ˆæ‰€æœ‰ï¼‰ã€‚<br>âš ï¸ å¦‚æœç”¨äº† `supports_credentials=True`ï¼Œ**ä¸èƒ½è®¾ä¸º `*`**ï¼Œå¿…é¡»æ˜ç¡®æŒ‡å®šåŸŸåï¼ |
| **`supports_credentials`** | `bool` | æ˜¯å¦å…è®¸å‰ç«¯æºå¸¦å‡­æ®ï¼ˆå¦‚ cookiesã€Authorization headerï¼‰ã€‚<br>âœ… å¦‚æœä½ è¦ç”¨ `Authorization: Bearer <token>`ï¼Œ**å…¶å®ä¸ä¸€å®šéœ€è¦å®ƒ**ï¼›ä½†å¦‚æœä½ ç”¨ cookies è®¤è¯ï¼Œåˆ™å¿…é¡»å¼€ã€‚ |
| **`methods`** | `list` | å…è®¸çš„ HTTP æ–¹æ³•ï¼Œé»˜è®¤æ˜¯ `["GET", "HEAD", "POST"]`ï¼Œå»ºè®®æ˜¾å¼å†™å…¨ã€‚ |
| **`allow_headers`** | `list` | å…è®¸çš„è¯·æ±‚å¤´ã€‚å¦‚æœä½ å‰ç«¯å‘ `Authorization`ï¼Œè¿™é‡Œå¿…é¡»åŒ…å« `"Authorization"`ï¼ |
| **`expose_headers`** | `list` | å…è®¸å‰ç«¯ JS è¯»å–çš„å“åº”å¤´ï¼ˆé»˜è®¤åªèƒ½è¯»åŸºæœ¬å¤´ï¼‰ã€‚ä¸€èˆ¬ä¸ç”¨ã€‚ |
| **`max_age`** | `int` | é¢„æ£€è¯·æ±‚ï¼ˆOPTIONSï¼‰ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œä¾‹å¦‚ `600`ã€‚ |

---

## ğŸ› ï¸ é’ˆå¯¹ä½ é¡¹ç›®çš„æ¨èé…ç½®

å› ä¸ºä½ ç”¨çš„æ˜¯ **JWT + Authorization header**ï¼ˆä¸æ˜¯ cookieï¼‰ï¼Œæ‰€ä»¥ï¼š

- âœ… éœ€è¦å…è®¸ `Authorization` å¤´
- âœ… å¼€å‘æ—¶å‰ç«¯å¯èƒ½æ˜¯ `http://localhost:3000` æˆ– `5173`ï¼ˆViteï¼‰
- âŒ ä¸ä¸€å®šéœ€è¦ `supports_credentials=True`ï¼ˆé™¤éä½ ç”¨ cookiesï¼‰

ä½†ä¸ºäº†é€šç”¨æ€§ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š

```python
def create_app():
    app = Flask(__name__)
    app.config.from_object(configdict['default'])
    
    db.init_app(app)
    migrate.init_app(app, db)

    # æ³¨å†Œè“å›¾
    app.register_blueprint(news_bp)
    app.register_blueprint(usr_bp)

    # CORS é…ç½®
    cors.init_app(app,
        origins=[
            "http://localhost:3000",
            "http://localhost:5173",
            "http://127.0.0.1:5173",
            "https://your-production-frontend.com"
        ],
        supports_credentials=True,  # å¦‚æœä½ æœªæ¥æƒ³æ”¯æŒ cookie ç™»å½•ï¼Œä¿ç•™å®ƒ
        methods=["GET", "POST", "PUT", "DELETE", "OPTIONS"],
        allow_headers=["Content-Type", "Authorization", "X-Requested-With"]
    )

    print(app.url_map)
    return app
```

> ğŸ’¡ **é‡è¦**ï¼šå½“ `supports_credentials=True` æ—¶ï¼Œ`origins` **ä¸èƒ½æ˜¯ `"*"`**ï¼Œå¦åˆ™æµè§ˆå™¨ä¼šæ‹’ç»ï¼

---

## ğŸŒ å‰ç«¯é…åˆï¼ˆAxios ç¤ºä¾‹ï¼‰

å¦‚æœä½ ç”¨ Axios å‘è¯·æ±‚ï¼Œç¡®ä¿ï¼š

```js
// ä¸éœ€è¦ withCredentialsï¼ˆé™¤éä½ ç”¨ cookiesï¼‰
const res = await axios.post('http://localhost:5000/api/login_vc', data, {
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded'
  }
});

// å¸¦ token è¯·æ±‚
axios.get('/api/profile', {
  headers: {
    'Authorization': 'Bearer ' + token
  }
});
```

åªè¦åç«¯ `allow_headers` åŒ…å« `"Authorization"`ï¼Œå°±èƒ½æ­£å¸¸è·¨åŸŸã€‚

---

## ğŸ§ª è°ƒè¯• CORS é—®é¢˜çš„å°æŠ€å·§

1. **çœ‹æµè§ˆå™¨ Network é¢æ¿**ï¼š
   - æ£€æŸ¥ OPTIONS é¢„æ£€è¯·æ±‚æ˜¯å¦ 200
   - çœ‹ Response Headers æ˜¯å¦æœ‰ `Access-Control-Allow-Origin` ç­‰
2. **åç«¯æ—¥å¿—**ï¼šFlask-CORS é»˜è®¤ä¸æ‰“æ—¥å¿—ï¼Œå¯ä¸´æ—¶åŠ ï¼š
   ```python
   import logging
   logging.getLogger('flask_cors').level = logging.DEBUG
   ```
3. **å…ˆå…³ CORS æµ‹è¯•**ï¼šæœ¬åœ°å¼€å‘æ—¶ï¼Œå¦‚æœå‰åç«¯åŒæºï¼ˆæ¯”å¦‚éƒ½éƒ¨ç½²åœ¨ Nginx ä¸‹ï¼‰ï¼Œå¯ä¸ç”¨ CORSã€‚

---

## âœ… æ€»ç»“

| åœºæ™¯ | æ¨èé…ç½® |
|------|--------|
| JWT + Authorization header | `allow_headers=["Authorization"]`ï¼Œ`origins` æ˜ç¡®æŒ‡å®šï¼Œ`supports_credentials=False`ï¼ˆå¯é€‰ï¼‰ |
| Cookie è®¤è¯ | å¿…é¡» `supports_credentials=True` + æ˜ç¡® `origins` |
| ç”Ÿäº§ç¯å¢ƒ | ä¸¥æ ¼é™åˆ¶ `origins`ï¼Œä¸è¦ç”¨ `*` |

ä½ ç°åœ¨åªéœ€è¦åŠ ä¸Š `origins` å’Œ `allow_headers`ï¼Œå°±èƒ½å®Œç¾æ”¯æŒå‰åç«¯åˆ†ç¦»å¼€å‘ï¼

å¦‚æœè¿˜æœ‰ç–‘é—®ï¼Œæ¯”å¦‚â€œå¦‚ä½•åŠ¨æ€è®¾ç½® originsâ€æˆ–â€œå…¨å±€ vs è“å›¾çº§ CORSâ€ï¼Œä¹Ÿæ¬¢è¿ç»§ç»­é—®ï¼ğŸ˜Š